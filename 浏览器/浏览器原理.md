# 浏览器原理

## DNS 解析

当我们输入一个a.com域名访问的时候，浏览器首先要去获取这个域名背后对应的ip地址，获取这个ip地址的方式分为两个步骤
* 有缓存直接从缓存中获取
* 没有缓存，去DNS服务器中获取，获取到之后会缓存

## 建立TCP连接

获取到ip地址之后浏览器会尝试建立TCP链接，也就是我们经常说的TCP三次握手

SYN -> SYN-ACK -> ACK
* 首先客户端发送一个SYN同步的包
* 服务端收到客户端SYN的同步包之后回复一个SYN+ACK的同步确认包
* 客户端收到服务端的SYN+ACK包之后回复一个ACK的确认包

如果是HTTP协议的话到这里链接就建立了，如果是HTTPS协议，还要进行TLS协商

```
为什么一定要三次握手呢？两次不行吗，答案是不行，三次握手是双方收发能力确认的过程，如果是两次，则服务端无法确认客户端的接收能力是否正常，所以最后一次的ACK是客户端告诉服务端，自己的接收能力没问题
```

## TLS协商

对于使用HTTPS协议的网站还需要协商使用哪种密码对会话进行加密。简化版的过程如下
* 客户端发送一个消息包含客户端支持的TLS版本，加密算法，加密套件 一个随机数
* 服务端收到消息之后返回一条消息消息内容包括服务端选择TLS版本，选择的密码套件，一个随机数，数字证书等
* 验证证书同时获取到证书的公钥
* 发送消息告诉服务端下次通信将使用服务端选择的加密套件加密消息
* 使用服务端返回的随机数和客户端发送的随机数再加一个新的随机数使用服务端选择的加密算法生成会话秘钥，然后使用服务端证书的公钥加密对新的随机数加密后，发送给服务端。
* 服务端收到消息之后，使用CA证书的私钥解密得到第三个随机数，然后通过之前选择的加密算法和三个随机数计算出会话秘钥
* 服务端给客户端发送消息告诉之后的通信都是加密的
* 之后客户端将会话摘要使用会话秘钥加密发送给服务端（对应clint_finished消息）
* 将会话的内容形成摘要使用会话秘钥加密发送给客户端（对应server_finished消息）

```
再整个过程中涉及到了非对称加密和对称加密， 对于秘钥的生成属于非对称加密，对于之后使用会话秘钥对数据数据的加密解密属于对称加密

* 对称机密： 用于加密和解密数据的密钥是相同的（AES, DES）
* 非对称加密：也称为公钥加密，是一种加密方法，其中使用一对密钥：一个公钥和一个私钥。这对密钥是数学相关的，但不能从一个密钥直接推导出另一个密钥。公钥可以公开分享，而私钥必须保密。公钥 (Public Key): 用于加密数据或验证数字签名。私钥 (Private Key): 用于解密数据或生成数字签名。(RSA, DSA)
```

## 解析(建立DOM, CSSOM)

建立tcp链接之后浏览器将会从目标服务器获取到网站的文档，然后解析成HTML文档，解析过程如下

* 页面从上到下开始解析DOM创建DOM数，在其中遇到script标签如果没有使用资源提示符则会暂停解析，并开始加载资源，加载执行完成后继续解析，遇到link标签开启下载但不会阻塞渲染流程
* 之后是构建CSSOM树，CSSOM树和DOM树是分离的，CSSOM树是针对CSS的，DOM树是针对HTML的
* 构建无障碍树（AOM）

```
预加载扫描器：浏览器构建DOM数的时候会占用主线程，同时会开启预加载扫描器对一些高优先级的资源提前下载（css, js，字体等）
```

## 渲染

 - 样式计算： 使用CSSOM树和DOM树构建renderTree，主要是标记出DOM树中的可视节点及计算样式（computedStyle）但不包括位置信息
 - 布局: 在样式计算中不会对renderTree进行布局计算，在这一步需要遍历整个renderTree，计算出每个节点的几何属性
 - 绘制（光栅化）: 布局完成之后会将整个计算的结果交给GPU去进行绘制。将内容提升到 GPU 上的层（而不是 CPU 上的主线程）可以提高绘制和重新绘制性能, 一些标签和css属性可以实例化一个层（video, canvas, opacity, transform, will-change）
 - 合成：当文档的各个部分以不同的层绘制，相互重叠时，必须进行合成，以确保它们以正确的顺序绘制到屏幕上，并正确显示内容。

 到此就完成了这个页面展示的过程，但到这里并不意味着整个网站的功能就完全了，因为主线程可能还在执行js脚本，导致无法处理界面交互。

```
* 重拍：经过第一次布局计算之后，随后对元素的几何属性（width, height, left, top, right, bottom, display: none）修改，都将会触发重排
* 重绘： 修改元素的样式属性（color, background-color等）会触发重绘。
```
